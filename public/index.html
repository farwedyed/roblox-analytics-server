<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Human or AI - Analytics Terminal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00dd48;
            --primary-color-glow: rgba(0, 221, 72, 0.5);
            --background-color: #000000;
            --panel-color: #0a0a0a;
            --surface-color: #111111;
            --border-color: #005a1e;
            --text-color: #00dd48;
            --text-secondary: #008f2f;
            --accent-red: #ff3333;
            --accent-blue: #33a1ff;
        }

        @keyframes pulse-glow {
            0% { text-shadow: 0 0 5px var(--primary-color-glow); }
            50% { text-shadow: 0 0 15px var(--primary-color); }
            100% { text-shadow: 0 0 5px var(--primary-color-glow); }
        }

        body {
            font-family: 'Press Start 2P', cursive;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 15px var(--primary-color-glow), inset 0 0 10px rgba(0,0,0,0.5);
            background-color: var(--panel-color);
        }
        header {
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 30px;
        }
        .logo {
            width: 120px;
            height: 120px;
            image-rendering: pixelated; /* Keeps the pixel art sharp */
            margin-bottom: 20px;
        }
        header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            animation: pulse-glow 3s infinite ease-in-out;
        }
        header p { color: var(--text-secondary); font-size: 0.9rem; }
        .view { display: none; }
        .view.active { display: block; }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background-color: var(--surface-color);
            padding: 20px;
            border: 2px solid var(--border-color);
        }
        .stat-card h3 { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 10px; text-transform: uppercase; }
        .stat-card .value { font-size: 1.8rem; font-weight: 700; color: var(--text-color); }
        .stat-card .details { font-size: 0.7rem; color: var(--text-secondary); margin-top: 10px; line-height: 1.4; }

        .filters {
            display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 30px;
            background-color: var(--surface-color); padding: 15px; border: 2px solid var(--border-color); justify-content: center; align-items: center;
        }
        .filters select, .filters button {
            background-color: #0A0A0A; border: 2px solid var(--primary-color); color: #39FF14;
            padding: 10px 15px; font-family: 'Press Start 2P', cursive; font-size: 0.8em; cursor: pointer;
        }
        .filters button:hover { box-shadow: 0 0 8px var(--primary-color-glow); }

        #games-container { display: grid; gap: 15px; }
        .game-card {
            background-color: var(--surface-color); border: 2px solid var(--border-color);
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            transition: background-color 0.2s ease;
        }
        .game-card-content { cursor: pointer; flex-grow: 1; }
        .game-card-content:hover .timestamp { text-decoration: underline; }
        .game-info .timestamp { font-size: 0.9rem; font-weight: 500; }
        .game-info .message-count { font-size: 0.7rem; color: var(--text-secondary); }
        .game-actions { display: flex; align-items: center; gap: 10px; }
        .game-tags { display: flex; gap: 8px; }
        .tag { padding: 5px 10px; font-size: 0.7rem; font-weight: 700; }
        .tag.ai-win { background-color: var(--accent-red); color: #fff; }
        .tag.ai-loss { background-color: var(--primary-color); color: var(--background-color); }
        .delete-btn {
            background-color: transparent; color: var(--accent-red); border: 1px solid var(--accent-red);
            padding: 5px 8px; font-size: 0.8rem; cursor: pointer;
        }
        .delete-btn:hover { background-color: var(--accent-red); color: #fff; }

        #back-button {
            background-color: var(--accent-blue); color: var(--background-color); border: none; padding: 12px 25px;
            font-family: 'Press Start 2P', cursive; font-size: 0.9rem; cursor: pointer; margin-bottom: 20px;
        }
        #chat-container { background-color: var(--surface-color); border: 2px solid var(--border-color); padding: 25px; display: flex; flex-direction: column; }
        .chat-bubble-wrapper { display: flex; flex-direction: column; margin-bottom: 15px; max-width: 80%; position: relative; }
        .chat-bubble-wrapper.player1 { align-self: flex-start; }
        .chat-bubble-wrapper.player2 { align-self: flex-end; }
        .chat-bubble { padding: 10px 15px; line-height: 1.5; font-size: 0.9em; }
        .chat-bubble-wrapper.player1 .chat-bubble { background-color: #003d14; border: 2px solid #005a1e; }
        .chat-bubble-wrapper.player2 .chat-bubble { background-color: #1a1a1a; border: 2px solid #333; }
        .message-meta { font-size: 0.7rem; color: var(--text-secondary); margin-top: 5px; padding: 0 8px; }
        .chat-bubble-wrapper.player2 .message-meta { text-align: right; }
        .chat-bubble-wrapper .chat-bubble[data-tooltip]::after {
            content: attr(data-tooltip); position: absolute; bottom: 100%; left: 10px; background-color: #000; border: 1px solid var(--primary-color);
            color: var(--primary-color); padding: 6px 10px; font-size: 0.8rem; white-space: nowrap; opacity: 0;
            transform: translateY(5px); transition: opacity 0.2s ease, transform 0.2s ease; pointer-events: none;
        }
        .chat-bubble-wrapper .chat-bubble:hover[data-tooltip]::after { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img src="https://i.postimg.cc/vH0Z8x7j/pixil-frame-0-1.png" alt="Human or AI Logo" class="logo">
            <h1>Analytics Terminal</h1>
            <p>Live data feed from in-game matches</p>
        </header>

        <div class="analytics-grid">
            <div class="stat-card"><h3>Total Games Logged</h3><div id="total-games" class="value">0</div><div id="total-games-details" class="details">AI vs Human Ratio</div></div>
            <div class="stat-card"><h3>AI Win Rate</h3><div id="ai-win-rate" class="value">0%</div><div id="ai-win-rate-details" class="details">0 wins / 0 losses</div></div>
            <div class="stat-card"><h3>API vs Pre-written</h3><div id="api-vs-prewritten" class="value">0%</div><div id="api-vs-prewritten-details" class="details">0 API / 0 Saved</div></div>
            <div class="stat-card"><h3>Est. Tokens Used</h3><div id="total-tokens" class="value">0</div><div class="details">Across all API calls</div></div>
        </div>
        <div id="model-usage-container" class="analytics-grid"></div>

        <div id="game-list-view" class="view active">
            <div class="filters">
                <select id="match-type-filter"><option value="all">All Match Types</option><option value="ai">AI Matches</option><option value="human">Human Matches</option></select>
                <select id="outcome-filter"><option value="all">All Outcomes</option><option value="ai-won">AI Won</option><option value="ai-lost">AI Lost</option></select>
                <button id="copy-btn">Copy Data</button>
                <button id="download-btn">Download Data</button>
            </div>
            <div id="games-container"><p id="loading">Awaiting data transmission...</p></div>
        </div>

        <div id="chat-log-view" class="view">
            <button id="back-button"><< Back to Log List</button>
            <div id="chat-container"></div>
        </div>
    </div>

    <script>
        // All JavaScript functionality remains exactly the same as the previous correct version.
        // It will automatically adopt the new styles from the CSS above.
        document.addEventListener('DOMContentLoaded', () => {
            let allLogs = [];
            const gameListView = document.getElementById('game-list-view');
            const chatLogView = document.getElementById('chat-log-view');
            const gamesContainer = document.getElementById('games-container');
            const chatContainer = document.getElementById('chat-container');
            const loadingIndicator = document.getElementById('loading');
            const matchTypeFilter = document.getElementById('match-type-filter');
            const outcomeFilter = document.getElementById('outcome-filter');
            const backButton = document.getElementById('back-button');
            const downloadBtn = document.getElementById('download-btn');
            const copyBtn = document.getElementById('copy-btn');
            const modelUsageContainer = document.getElementById('model-usage-container');

            function updateAnalytics(logs) {
                let totalGames = logs.length; let aiGames = 0; let humanGames = 0;
                let aiWins = 0; let aiLosses = 0; let apiCalls = 0;
                let prewrittenCalls = 0; let totalTokens = 0; const modelUsage = {};

                logs.forEach(log => {
                    if (log.wasAiGame) {
                        aiGames++;
                        if (log.aiWon) aiWins++; else aiLosses++;
                    } else { humanGames++; }
                    log.matchLog.forEach(msg => {
                        if (msg.author && (msg.author === 'Player1' || msg.author === 'Player2')) {
                            if (msg.source === 'API Call') {
                                apiCalls++;
                                totalTokens += (msg.tokens || 0);
                                if (msg.model) { modelUsage[msg.model] = (modelUsage[msg.model] || 0) + 1; }
                            } else if (msg.source && msg.source.startsWith('Pre-written')) {
                                prewrittenCalls++;
                            }
                        }
                    });
                });

                document.getElementById('total-games').textContent = totalGames;
                document.getElementById('total-games-details').textContent = `${aiGames} AI / ${humanGames} Human`;
                const aiWinRate = aiGames > 0 ? ((aiWins / aiGames) * 100).toFixed(1) : 0;
                document.getElementById('ai-win-rate').textContent = `${aiWinRate}%`;
                document.getElementById('ai-win-rate-details').textContent = `${aiWins} wins / ${aiLosses} losses`;
                const totalResponses = apiCalls + prewrittenCalls;
                const apiRate = totalResponses > 0 ? ((apiCalls / totalResponses) * 100).toFixed(1) : 0;
                document.getElementById('api-vs-prewritten').textContent = `${apiRate}%`;
                document.getElementById('api-vs-prewritten-details').textContent = `${apiCalls} API / ${prewrittenCalls} Saved`;
                document.getElementById('total-tokens').textContent = totalTokens.toLocaleString();
                modelUsageContainer.innerHTML = '';
                for (const modelName in modelUsage) {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `<h3>Model Usage</h3><div class="value">${modelUsage[modelName]}</div><div class="details">${modelName}</div>`;
                    modelUsageContainer.appendChild(card);
                }
            }

            function renderGameList() {
                gamesContainer.innerHTML = '';
                const filteredLogs = getFilteredLogs();
                if (filteredLogs.length === 0) {
                    gamesContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No logs match the current filters.</p>';
                    return;
                }
                filteredLogs.forEach(log => {
                    const card = document.createElement('div');
                    card.className = `game-card ${log.wasAiGame ? 'ai-match' : 'human-match'}`;
                    let tags = log.wasAiGame ? `<span class="tag ${log.aiWon ? 'ai-win' : 'ai-loss'}">${log.aiWon ? 'AI Won' : 'AI Lost'}</span>` : '';
                    card.innerHTML = `<div class="game-card-content" data-log-id="${log.id}"><div class="game-info"><div class="timestamp">${new Date(log.timestamp).toLocaleString()}</div><div class="message-count">${log.matchLog.length} messages</div></div></div><div class="game-actions"><div class="game-tags">${tags}</div><button class="delete-btn" data-log-id="${log.id}">DELETE</button></div>`;
                    gamesContainer.appendChild(card);
                });
            }

            function renderChatLog(logId) {
                const log = allLogs.find(l => l.id.toString() === logId.toString());
                if (!log) return;
                gameListView.classList.remove('active');
                chatLogView.classList.add('active');
                chatContainer.innerHTML = '';
                log.matchLog.forEach(msg => {
                    const wrapper = document.createElement('div');
                    wrapper.className = `chat-bubble-wrapper ${msg.author.toLowerCase()}`;
                    const bubble = document.createElement('div');
                    bubble.className = 'chat-bubble';
                    bubble.textContent = msg.content;
                    if (msg.source) {
                        let tooltipText = msg.source;
                        if (msg.source === 'API Call' && msg.model) { tooltipText += ` (${msg.model})`; }
                        bubble.dataset.tooltip = tooltipText;
                    }
                    const meta = document.createElement('div');
                    meta.className = 'message-meta';
                    meta.textContent = `at ${msg.timestampSec}s`;
                    wrapper.appendChild(bubble);
                    wrapper.appendChild(meta);
                    chatContainer.appendChild(wrapper);
                });
            }
            
            async function fetchAndRender() {
                try {
                    const response = await fetch('/api/get-logs');
                    if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                    allLogs = await response.json();
                    loadingIndicator.style.display = 'none';
                    updateAnalytics(allLogs);
                    renderGameList();
                } catch (error) {
                    console.error('Failed to fetch logs:', error);
                    loadingIndicator.textContent = 'Error loading logs. Check server console.';
                }
            }

            function getFilteredLogs() {
                const typeFilter = matchTypeFilter.value;
                const outcomeFilterValue = outcomeFilter.value;
                return allLogs.filter(log => {
                    if (!log || !log.matchLog) return false;
                    const typeMatch = typeFilter === 'all' || (typeFilter === 'ai' && log.wasAiGame) || (typeFilter === 'human' && !log.wasAiGame);
                    if (!typeMatch) return false;
                    const outcomeMatch = outcomeFilterValue === 'all' || (outcomeFilterValue === 'ai-won' && log.aiWon) || (outcomeFilterValue === 'ai-lost' && !log.aiWon && log.wasAiGame);
                    return outcomeMatch;
                });
            }

            function formatLogsForExport() {
                let textContent = `GAME ANALYTICS DATA - ${new Date().toLocaleString()}\n`;
                textContent += "==================================================\n\n";
                const logsToExport = getFilteredLogs();
                logsToExport.forEach(log => {
                    textContent += `--- MATCH ID: ${log.id} | TIMESTAMP: ${new Date(log.timestamp).toLocaleString()} ---\n`;
                    textContent += `Type: ${log.wasAiGame ? 'AI Match' : 'Human Match'}\n`;
                    if (log.wasAiGame) { textContent += `Outcome: ${log.aiWon ? 'AI Won' : 'AI Lost'}\n`; }
                    textContent += "\n";
                    log.matchLog.forEach(msg => {
                        let sourceInfo = '';
                        if (msg.author && msg.source) {
                             sourceInfo = ` [Source: ${msg.source}`;
                            if (msg.source === 'API Call' && msg.model) { sourceInfo += ` (${msg.model})`; }
                             sourceInfo += ']';
                             if (msg.tokens) { sourceInfo += ` [Tokens: ${msg.tokens}]`; }
                        }
                        textContent += `[${msg.timestampSec}s] ${msg.author}: ${msg.content}${sourceInfo}\n`;
                    });
                    textContent += "--------------------------------------------------\n\n";
                });
                return textContent;
            }

            function downloadToFile(content, filename, contentType) {
                const a = document.createElement('a');
                const file = new Blob([content], {type: contentType});
                a.href = URL.createObjectURL(file);
                a.download = filename;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            }

            matchTypeFilter.addEventListener('change', renderGameList);
            outcomeFilter.addEventListener('change', renderGameList);
            
            gamesContainer.addEventListener('click', async (e) => {
                const deleteButton = e.target.closest('.delete-btn');
                const cardContent = e.target.closest('.game-card-content');
                
                if (deleteButton) {
                    e.stopPropagation();
                    const logId = parseInt(deleteButton.dataset.logId, 10);
                    const password = prompt("Enter the password to delete this log:");
                    if (password === null) return;
                    if (password !== "22ai23") { alert("Incorrect password."); return; }
                    try {
                        const response = await fetch(`/api/delete-log/${logId}`, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ password: password })
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || "Failed to delete log.");
                        }
                        await fetchAndRender();
                    } catch (error) {
                        console.error("Deletion failed:", error);
                        alert(`Error: ${error.message}`);
                    }
                } else if (cardContent) { renderChatLog(cardContent.dataset.logId); }
            });

            backButton.addEventListener('click', () => {
                chatLogView.classList.remove('active');
                gameListView.classList.add('active');
            });

            downloadBtn.addEventListener('click', () => {
                const filtered = getFilteredLogs();
                if (filtered.length > 0) {
                    const fileContent = formatLogsForExport();
                    downloadToFile(fileContent, 'roblox_chat_logs.txt', 'text/plain');
                } else { alert('No log data to download.'); }
            });

            copyBtn.addEventListener('click', () => {
                const filtered = getFilteredLogs();
                if (filtered.length > 0) {
                    const fileContent = formatLogsForExport();
                    navigator.clipboard.writeText(fileContent).then(() => {
                        const originalText = copyBtn.textContent;
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => { copyBtn.textContent = originalText; }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy text: ', err);
                        alert('Failed to copy data to clipboard.');
                    });
                } else { alert('No log data to copy.'); }
            });

            fetchAndRender();
            setInterval(fetchAndRender, 10000); 
        });
    </script>
</body>
</html>
