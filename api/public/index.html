<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Analytics Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Fira+Code&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1b26; --surface-color: #24283b; --panel-color: #1f2335;
            --text-color: #c0caf5; --text-secondary: #a9b1d6; --accent-color: #7aa2f7;
            --player1-msg-bg: #414868; --player2-msg-bg: #2d334d; --border-color: #3b4261;
            --ai-match-color: #e0af68; --human-match-color: #73daca; --win-color: #9ece6a;
            --loss-color: #f7768e; --download-btn-bg: #bb9af7; --delete-btn-bg: #db4b4b;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; overflow-x: hidden; }
        .container { max-width: 1000px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; }
        header h1 { font-size: 2.2rem; margin-bottom: 5px; }
        header p { color: var(--text-secondary); }
        .view { display: none; }
        .view.active { display: block; }
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background-color: var(--surface-color); padding: 20px; border-radius: 8px; border-left: 4px solid var(--accent-color); }
        .stat-card h3 { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 10px; text-transform: uppercase; }
        .stat-card .value { font-size: 2rem; font-weight: 700; color: var(--text-color); }
        .stat-card .details { font-size: 0.8rem; color: var(--text-secondary); margin-top: 10px; }
        .filters { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 30px; background-color: var(--panel-color); padding: 15px; border-radius: 8px; justify-content: center; align-items: center; }
        .filters select, .filters button { background-color: var(--surface-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px 12px; font-family: inherit; font-size: 0.9rem; cursor: pointer; transition: background-color 0.2s ease; }
        .filters button:hover { background-color: #3b4261; }
        #download-btn { background-color: var(--download-btn-bg); color: var(--bg-color); font-weight: 700; border: none; }
        #copy-btn { background-color: var(--accent-color); color: var(--bg-color); font-weight: 700; border: none; }
        .delete-btn { background-color: var(--delete-btn-bg); color: #fff; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.75rem; font-weight: 700; cursor: pointer; transition: background-color 0.2s ease; }
        .delete-btn:hover { background-color: #b83b3b; }
        #games-container { display: grid; gap: 15px; }
        .game-card { background-color: var(--surface-color); border: 1px solid var(--border-color); border-left: 5px solid; border-radius: 8px; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s ease, transform 0.2s ease; }
        .game-card:hover { background-color: #3b4261; transform: translateY(-2px); }
        .game-card-content { cursor: pointer; flex-grow: 1; }
        .game-card.ai-match { border-left-color: var(--ai-match-color); }
        .game-card.human-match { border-left-color: var(--human-match-color); }
        .game-info .timestamp { font-size: 1.1rem; font-weight: 500; }
        .game-info .message-count { font-size: 0.85rem; color: var(--text-secondary); }
        .game-actions { display: flex; align-items: center; gap: 10px; }
        .game-tags { display: flex; gap: 8px; }
        .tag { padding: 4px 10px; border-radius: 15px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .tag.ai-win { background-color: var(--loss-color); color: #fff; }
        .tag.ai-loss { background-color: var(--win-color); color: var(--bg-color); }
        #back-button { background-color: var(--accent-color); color: var(--bg-color); border: none; padding: 10px 20px; border-radius: 6px; font-weight: 700; font-size: 0.9rem; cursor: pointer; margin-bottom: 20px; }
        #chat-container { background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; display: flex; flex-direction: column; }
        .chat-bubble-wrapper { display: flex; flex-direction: column; margin-bottom: 15px; max-width: 80%; position: relative; }
        .chat-bubble-wrapper.player1 { align-self: flex-start; }
        .chat-bubble-wrapper.player2 { align-self: flex-end; }
        .chat-bubble { padding: 10px 15px; border-radius: 18px; line-height: 1.5; }
        .chat-bubble-wrapper.player1 .chat-bubble { background-color: var(--player1-msg-bg); border-bottom-left-radius: 4px; }
        .chat-bubble-wrapper.player2 .chat-bubble { background-color: var(--player2-msg-bg); border-bottom-right-radius: 4px; }
        .message-meta { font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px; padding: 0 8px; }
        .chat-bubble-wrapper.player2 .message-meta { text-align: right; }
        .chat-bubble-wrapper .chat-bubble[data-tooltip]::after {
            content: attr(data-tooltip); position: absolute; bottom: 100%; left: 10px; background-color: #16161e;
            color: #c0caf5; padding: 6px 10px; border-radius: 5px; font-size: 0.8rem; font-family: 'Fira Code', monospace;
            white-space: nowrap; opacity: 0; transform: translateY(5px); transition: opacity 0.2s ease, transform 0.2s ease; pointer-events: none;
        }
        .chat-bubble-wrapper .chat-bubble:hover[data-tooltip]::after { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>
    <div class="container">
        <header><h1>Game Analytics Dashboard</h1><p>Live data collected from in-game matches to improve the AI.</p></header>

        <div class="analytics-grid">
            <div class="stat-card"><h3>Total Games Logged</h3><div id="total-games" class="value">0</div><div id="total-games-details" class="details">AI vs Human Ratio</div></div>
            <div class="stat-card"><h3>AI Win Rate</h3><div id="ai-win-rate" class="value">0%</div><div id="ai-win-rate-details" class="details">0 wins / 0 losses</div></div>
            <div class="stat-card"><h3>API vs Pre-written</h3><div id="api-vs-prewritten" class="value">0%</div><div id="api-vs-prewritten-details" class="details">0 API Calls / 0 Saved</div></div>
            <div class="stat-card"><h3>Est. Tokens Used</h3><div id="total-tokens" class="value">0</div><div class="details">Across all API calls</div></div>
        </div>
        <div id="model-usage-container" class="analytics-grid"></div>

        <div id="game-list-view" class="view active">
            <div class="filters">
                <select id="match-type-filter"><option value="all">All Match Types</option><option value="ai">AI Matches</option><option value="human">Human Matches</option></select>
                <select id="outcome-filter"><option value="all">All Outcomes</option><option value="ai-won">AI Won</option><option value="ai-lost">AI Lost</option></select>
                <button id="copy-btn">Copy Filtered Data</button>
                <button id="download-btn">Download Filtered Data</button>
            </div>
            <div id="games-container"><p id="loading">Loading latest logs...</p></div>
        </div>

        <div id="chat-log-view" class="view">
            <button id="back-button">&larr; Back to Game List</button>
            <div id="chat-container"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let allLogs = [];
            const gameListView = document.getElementById('game-list-view');
            const chatLogView = document.getElementById('chat-log-view');
            const gamesContainer = document.getElementById('games-container');
            const chatContainer = document.getElementById('chat-container');
            const loadingIndicator = document.getElementById('loading');
            const matchTypeFilter = document.getElementById('match-type-filter');
            const outcomeFilter = document.getElementById('outcome-filter');
            const backButton = document.getElementById('back-button');
            const downloadBtn = document.getElementById('download-btn');
            const copyBtn = document.getElementById('copy-btn');
            const modelUsageContainer = document.getElementById('model-usage-container');

            function updateAnalytics(logs) {
                let totalGames = logs.length; let aiGames = 0; let humanGames = 0;
                let aiWins = 0; let aiLosses = 0; let apiCalls = 0;
                let prewrittenCalls = 0; let totalTokens = 0; const modelUsage = {};

                logs.forEach(log => {
                    if (log.wasAiGame) {
                        aiGames++;
                        if (log.aiWon) aiWins++; else aiLosses++;
                    } else { humanGames++; }
                    log.matchLog.forEach(msg => {
                        if (msg.author && (msg.author === 'Player1' || msg.author === 'Player2')) {
                            if (msg.source === 'API Call') {
                                apiCalls++;
                                totalTokens += (msg.tokens || 0);
                                if (msg.model) { modelUsage[msg.model] = (modelUsage[msg.model] || 0) + 1; }
                            } else if (msg.source && msg.source.startsWith('Pre-written')) {
                                prewrittenCalls++;
                            }
                        }
                    });
                });

                document.getElementById('total-games').textContent = totalGames;
                document.getElementById('total-games-details').textContent = `${aiGames} AI / ${humanGames} Human`;
                const aiWinRate = aiGames > 0 ? ((aiWins / aiGames) * 100).toFixed(1) : 0;
                document.getElementById('ai-win-rate').textContent = `${aiWinRate}%`;
                document.getElementById('ai-win-rate-details').textContent = `${aiWins} wins / ${aiLosses} losses`;
                const totalResponses = apiCalls + prewrittenCalls;
                const apiRate = totalResponses > 0 ? ((apiCalls / totalResponses) * 100).toFixed(1) : 0;
                document.getElementById('api-vs-prewritten').textContent = `${apiRate}%`;
                document.getElementById('api-vs-prewritten-details').textContent = `${apiCalls} API / ${prewrittenCalls} Saved`;
                document.getElementById('total-tokens').textContent = totalTokens.toLocaleString();
                modelUsageContainer.innerHTML = '';
                for (const modelName in modelUsage) {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `<h3>Model Usage</h3><div class="value">${modelUsage[modelName]}</div><div class="details">${modelName}</div>`;
                    modelUsageContainer.appendChild(card);
                }
            }

            function renderGameList() {
                gamesContainer.innerHTML = '';
                const filteredLogs = getFilteredLogs();
                if (filteredLogs.length === 0) {
                    gamesContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No logs match the current filters.</p>';
                    return;
                }
                filteredLogs.forEach(log => {
                    const card = document.createElement('div');
                    card.className = `game-card ${log.wasAiGame ? 'ai-match' : 'human-match'}`;
                    let tags = log.wasAiGame ? `<span class="tag ${log.aiWon ? 'ai-win' : 'ai-loss'}">${log.aiWon ? 'AI Won' : 'AI Lost'}</span>` : '';
                    card.innerHTML = `<div class="game-card-content" data-log-id="${log.id}"><div class="game-info"><div class="timestamp">${new Date(log.timestamp).toLocaleString()}</div><div class="message-count">${log.matchLog.length} messages</div></div></div><div class="game-actions"><div class="game-tags">${tags}</div><button class="delete-btn" data-log-id="${log.id}">&#128465;</button></div>`;
                    gamesContainer.appendChild(card);
                });
            }

            function renderChatLog(logId) {
                const log = allLogs.find(l => l.id.toString() === logId.toString());
                if (!log) return;
                gameListView.classList.remove('active');
                chatLogView.classList.add('active');
                chatContainer.innerHTML = '';
                log.matchLog.forEach(msg => {
                    const wrapper = document.createElement('div');
                    wrapper.className = `chat-bubble-wrapper ${msg.author.toLowerCase()}`;
                    const bubble = document.createElement('div');
                    bubble.className = 'chat-bubble';
                    bubble.textContent = msg.content;
                    if (msg.source) {
                        let tooltipText = msg.source;
                        if (msg.source === 'API Call' && msg.model) { tooltipText += ` (${msg.model})`; }
                        bubble.dataset.tooltip = tooltipText;
                    }
                    const meta = document.createElement('div');
                    meta.className = 'message-meta';
                    meta.textContent = `at ${msg.timestampSec}s`;
                    wrapper.appendChild(bubble);
                    wrapper.appendChild(meta);
                    chatContainer.appendChild(wrapper);
                });
            }
            
            async function fetchAndRender() {
                try {
                    const response = await fetch('/api/get-logs');
                    if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                    allLogs = await response.json();
                    loadingIndicator.style.display = 'none';
                    updateAnalytics(allLogs);
                    renderGameList();
                } catch (error) {
                    console.error('Failed to fetch logs:', error);
                    loadingIndicator.textContent = 'Error loading logs. Check server console.';
                }
            }

            function getFilteredLogs() {
                const typeFilter = matchTypeFilter.value;
                const outcomeFilterValue = outcomeFilter.value;
                return allLogs.filter(log => {
                    if (!log || !log.matchLog) return false;
                    const typeMatch = typeFilter === 'all' || (typeFilter === 'ai' && log.wasAiGame) || (typeFilter === 'human' && !log.wasAiGame);
                    if (!typeMatch) return false;
                    const outcomeMatch = outcomeFilterValue === 'all' || (outcomeFilterValue === 'ai-won' && log.aiWon) || (outcomeFilterValue === 'ai-lost' && !log.aiWon && log.wasAiGame);
                    return outcomeMatch;
                });
            }

            function formatLogsForExport() {
                let textContent = `GAME ANALYTICS DATA - ${new Date().toLocaleString()}\n`;
                textContent += "==================================================\n\n";
                const logsToExport = getFilteredLogs();
                logsToExport.forEach(log => {
                    textContent += `--- MATCH ID: ${log.id} | TIMESTAMP: ${new Date(log.timestamp).toLocaleString()} ---\n`;
                    textContent += `Type: ${log.wasAiGame ? 'AI Match' : 'Human Match'}\n`;
                    if (log.wasAiGame) { textContent += `Outcome: ${log.aiWon ? 'AI Won' : 'AI Lost'}\n`; }
                    textContent += "\n";
                    log.matchLog.forEach(msg => {
                        let sourceInfo = '';
                        if (msg.author && msg.source) {
                             sourceInfo = ` [Source: ${msg.source}`;
                            if (msg.source === 'API Call' && msg.model) { sourceInfo += ` (${msg.model})`; }
                             sourceInfo += ']';
                             if (msg.tokens) { sourceInfo += ` [Tokens: ${msg.tokens}]`; }
                        }
                        textContent += `[${msg.timestampSec}s] ${msg.author}: ${msg.content}${sourceInfo}\n`;
                    });
                    textContent += "--------------------------------------------------\n\n";
                });
                return textContent;
            }

            function downloadToFile(content, filename, contentType) {
                const a = document.createElement('a');
                const file = new Blob([content], {type: contentType});
                a.href = URL.createObjectURL(file);
                a.download = filename;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            }

            matchTypeFilter.addEventListener('change', renderGameList);
            outcomeFilter.addEventListener('change', renderGameList);
            
            gamesContainer.addEventListener('click', async (e) => {
                const deleteButton = e.target.closest('.delete-btn');
                const cardContent = e.target.closest('.game-card-content');
                
                if (deleteButton) {
                    e.stopPropagation();
                    const logId = parseInt(deleteButton.dataset.logId, 10);
                    const password = prompt("Enter the password to delete this log:");
                    if (password === null) return;
                    if (password !== "22ai23") { alert("Incorrect password."); return; }
                    try {
                        const response = await fetch(`/api/delete-log/${logId}`, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ password: password })
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || "Failed to delete log.");
                        }
                        await fetchAndRender();
                    } catch (error) {
                        console.error("Deletion failed:", error);
                        alert(`Error: ${error.message}`);
                    }
                } else if (cardContent) { renderChatLog(cardContent.dataset.logId); }
            });

            backButton.addEventListener('click', () => {
                chatLogView.classList.remove('active');
                gameListView.classList.add('active');
            });

            downloadBtn.addEventListener('click', () => {
                const filtered = getFilteredLogs();
                if (filtered.length > 0) {
                    const fileContent = formatLogsForExport();
                    downloadToFile(fileContent, 'roblox_chat_logs.txt', 'text/plain');
                } else { alert('No log data to download.'); }
            });

            copyBtn.addEventListener('click', () => {
                const filtered = getFilteredLogs();
                if (filtered.length > 0) {
                    const fileContent = formatLogsForExport();
                    navigator.clipboard.writeText(fileContent).then(() => {
                        const originalText = copyBtn.textContent;
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => { copyBtn.textContent = originalText; }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy text: ', err);
                        alert('Failed to copy data to clipboard.');
                    });
                } else { alert('No log data to copy.'); }
            });

            fetchAndRender();
            setInterval(fetchAndRender, 10000); 
        });
    </script>
</body>
</html>
